<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Dashboard - HMS Analytics</title>
    <style>
        /* ‚Äî‚Äî‚Äî styles unchanged ‚Äî‚Äî‚Äî */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 40px; margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 20px; }
        .header-content h1 { font-size: 32px; color: #1f2937; margin-bottom: 8px; }
        .header-content p { color: #6b7280; font-size: 16px; }
        .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-flex;
            align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { font-size: 36px; margin-bottom: 15px; }
        .stat-value { font-size: 32px; font-weight: 700; color: #667eea; margin-bottom: 5px; }
        .stat-label { color: #6b7280; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .reports-section { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .section-header { display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #f3f4f6; flex-wrap: wrap; gap: 15px; }
        .section-header h2 { font-size: 24px; color: #1f2937; }
        .filters-search { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .search-box { position: relative; }
        .search-box input { padding: 10px 40px 10px 15px; border: 2px solid #e5e7eb; border-radius: 10px;
            font-size: 14px; width: 300px; transition: border 0.3s; }
        .search-box input:focus { outline: none; border-color: #667eea; }
        .search-box button { position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            background: #667eea; border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .filter-select { padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;
            cursor: pointer; background: white; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #f3f4f6; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-appointments { background: #dbeafe; color: #1e40af; }
        .badge-revenue { background: #d1fae5; color: #065f46; }
        .badge-patients { background: #fce7f3; color: #9f1239; }
        .btn-small { padding: 8px 16px; font-size: 13px; }
        .btn-view { background: #667eea; color: white; margin-right: 5px; }
        .btn-edit { background: #10b981; color: white; margin-right: 5px; }
        .btn-download { background: #8b5cf6; color: white; margin-right: 5px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .alert-success { background: #d1fae5; border-left: 4px solid #10b981; color: #065f46; }
        .alert-error { background: #fee2e2; border-left: 4px solid #ef4444; color: #991b1b; }
        .bulk-actions { background: #f9fafb; padding: 15px; border-radius: 10px; margin-bottom: 20px;
            display: none; align-items: center; justify-content: space-between; }
        .bulk-actions.active { display: flex; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; flex-wrap: wrap; }
        .pagination a, .pagination span { padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px;
            text-decoration: none; color: #374151; font-weight: 600; transition: all 0.3s; }
        .pagination a:hover { background: #667eea; color: white; border-color: #667eea; }
        .pagination .active { background: #667eea; color: white; border-color: #667eea; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%;
            max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 2px solid #f3f4f6; }
        .form-group { margin-bottom: 20px; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-content">
            <h1>üìä Reports Dashboard</h1>
            <p>View and manage all generated analytics reports</p>
        </div>
        <div class="header-actions">
            <a th:href="@{/analytics/manual-reports}" class="btn btn-primary">‚ûï Create New Report</a>
            <button class="btn btn-secondary" onclick="openCleanupModal()">üóëÔ∏è Cleanup Old Reports</button>
        </div>
    </div>

    <!-- Alerts -->
    <div class="alert alert-success" th:if="${success}">
        <span>‚úì</span>
        <p th:text="${success}">Operation successful!</p>
    </div>
    <div class="alert alert-error" th:if="${error}">
        <span>‚ö†Ô∏è</span>
        <p th:text="${error}">An error occurred.</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìã</div>
            <div class="stat-value" th:text="${totalItems != null ? totalItems : 0}">0</div>
            <div class="stat-label">Total Reports</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <div class="stat-value" th:text="${currentPage != null ? currentPage + 1 : 1}">1</div>
            <div class="stat-label">Current Page</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìÑ</div>
            <div class="stat-value" th:text="${totalPages != null ? totalPages : 1}">1</div>
            <div class="stat-label">Total Pages</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-value">Auto</div>
            <div class="stat-label">Generation Mode</div>
        </div>
    </div>

    <div class="reports-section">
        <div class="section-header">
            <h2>üóÇÔ∏è Saved Reports</h2>
            <div class="filters-search">
                <form th:action="@{/analytics/report-history/search}" method="get" class="search-box">
                    <input type="text" name="query" placeholder="Search reports..." th:value="${searchQuery}">
                    <button type="submit">üîç</button>
                </form>
                <form th:action="@{/analytics/report-history}" method="get">
                    <select name="type" class="filter-select" onchange="this.form.submit()">
                        <option value="">All Types</option>
                        <option value="Appointments" th:selected="${selectedType == 'Appointments'}">Appointments</option>
                        <option value="Revenue" th:selected="${selectedType == 'Revenue'}">Revenue</option>
                        <option value="Patients" th:selected="${selectedType == 'Patients'}">Patients</option>
                    </select>
                </form>
            </div>
        </div>

        <!-- Bulk delete -->
        <div class="bulk-actions" id="bulkActionsBar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="selectedCount">0 selected</span>
                <button class="btn btn-small btn-danger" onclick="bulkDelete()">üóëÔ∏è Delete Selected</button>
            </div>
            <button class="btn btn-small btn-secondary" onclick="deselectAll()">Clear Selection</button>
        </div>

        <div th:if="${reports != null and !reports.isEmpty()}">
            <form id="bulkForm" th:action="@{/analytics/report-history/bulk-delete}" method="post">
                <!-- CSRF token -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <table>
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Period</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="report : ${reports}">
                        <td><input type="checkbox" name="reportIds" th:value="${report.id}" class="report-checkbox" onchange="updateBulkActions()"></td>
                        <td th:text="'#' + ${report.id}">1</td>
                        <td><strong th:text="${report.title}">Report Title</strong></td>
                        <td>
                                <span class="badge"
                                      th:classappend="${report.type == 'Appointments' ? 'badge-appointments' : (report.type == 'Revenue' ? 'badge-revenue' : 'badge-patients')}"
                                      th:text="${report.type}">Type</span>
                        </td>
                        <td th:text="${report.period}">January 2024</td>
                        <td th:text="${#temporals.format(report.createdAt, 'dd MMM yyyy HH:mm')}">01 Jan 2024</td>
                        <td>
                            <a th:href="@{/analytics/report-history/{id}(id=${report.id})}" class="btn btn-small btn-view" title="View">üëÅÔ∏è</a>
                            <a th:href="@{/analytics/report-history/{id}/edit(id=${report.id})}" class="btn btn-small btn-edit" title="Edit">‚úèÔ∏è</a>
                            <a th:href="@{/analytics/report-history/{id}/download-pdf(id=${report.id})}" class="btn btn-small btn-download" title="Download">üì•</a>
                            <button type="button" class="btn btn-small btn-delete"
                                    th:onclick="'confirmDelete(' + ${report.id} + ', \'' + ${report.title} + '\')'">üóëÔ∏è</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </form>

            <!-- Pagination -->
            <div class="pagination" th:if="${totalPages > 1}">
                <a th:if="${currentPage > 0}" th:href="@{/analytics/report-history(page=${currentPage - 1}, size=10)}">‚Üê Previous</a>
                <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                    <a th:if="${i == currentPage}" class="active">[[${i + 1}]]</a>
                    <a th:unless="${i == currentPage}" th:href="@{/analytics/report-history(page=${i}, size=10)}">[[${i + 1}]]</a>
                </span>
                <a th:if="${currentPage < totalPages - 1}" th:href="@{/analytics/report-history(page=${currentPage + 1}, size=10)}">Next ‚Üí</a>
            </div>
        </div>

        <div class="empty-state" th:if="${reports == null or reports.isEmpty()}">
            <div class="empty-state-icon">üì≠</div>
            <p th:if="${searchQuery != null}">No reports found matching "<span th:text="${searchQuery}"></span>"</p>
            <p th:unless="${searchQuery != null}">No reports available</p>
            <a th:href="@{/analytics/manual-reports}" class="btn btn-primary" style="margin-top:20px;">Generate Your First Report</a>
        </div>
    </div>
</div>

<!-- Delete modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚ö†Ô∏è Confirm Delete</h3>
            <button class="close-modal" onclick="closeDeleteModal()">√ó</button>
        </div>
        <p>Are you sure you want to delete "<strong id="reportTitle"></strong>"?</p>
        <p style="color:#ef4444;font-size:14px;margin-top:10px;">This action cannot be undone.</p>
        <form id="deleteForm" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete Report</button>
            </div>
        </form>
    </div>
</div>

<!-- Cleanup modal -->
<div id="cleanupModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üóëÔ∏è Cleanup Old Reports</h3>
            <button class="close-modal" onclick="closeCleanupModal()">√ó</button>
        </div>
        <form th:action="@{/analytics/report-history/cleanup}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="form-group">
                <label>Delete reports older than:</label>
                <select name="daysOld" required>
                    <option value="30">30 days</option>
                    <option value="60">60 days</option>
                    <option value="90">90 days</option>
                    <option value="180">180 days</option>
                    <option value="365">1 year</option>
                </select>
            </div>
            <p style="color:#ef4444;font-size:14px;">‚ö†Ô∏è This will permanently delete old reports.</p>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCleanupModal()">Cancel</button>
                <button type="submit" class="btn btn-danger">Cleanup</button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleSelectAll(){const s=document.getElementById('selectAll');document.querySelectorAll('.report-checkbox').forEach(cb=>cb.checked=s.checked);updateBulkActions();}
    function updateBulkActions(){const c=document.querySelectorAll('.report-checkbox:checked');const b=document.getElementById('bulkActionsBar');const sc=document.getElementById('selectedCount');if(c.length>0){b.classList.add('active');sc.textContent=c.length+' selected';}else{b.classList.remove('active');}}
    function deselectAll(){document.querySelectorAll('.report-checkbox').forEach(cb=>cb.checked=false);document.getElementById('selectAll').checked=false;updateBulkActions();}
    function bulkDelete(){if(document.querySelectorAll('.report-checkbox:checked').length===0)return;if(confirm('Delete selected reports? This cannot be undone.'))document.getElementById('bulkForm').submit();}
    function confirmDelete(id,title){document.getElementById('reportTitle').textContent=title;document.getElementById('deleteForm').action='/analytics/report-history/'+id+'/delete';document.getElementById('deleteModal').classList.add('active');}
    function closeDeleteModal(){document.getElementById('deleteModal').classList.remove('active');}
    function openCleanupModal(){document.getElementById('cleanupModal').classList.add('active');}
    function closeCleanupModal(){document.getElementById('cleanupModal').classList.remove('active');}
    window.onclick=function(e){if(e.target.classList.contains('modal'))e.target.classList.remove('active');}
</script>
</body>
</html>
